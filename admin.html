<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RDM Jobs Admin</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Custom Styling -->
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f8f9fa;
      padding-top: 80px; /* Space for header */
    }
    #loginSection .card {
      border-radius: 12px;
    }
    .btn-sm, .form-control, .form-select {
      font-size: 0.9rem;
    }
    .table td, .table th {
      vertical-align: middle;
    }
    @media (max-width: 576px) {
      .modal-lg {
        max-width: 95% !important;
      }
    }
    #adminPanel h5 {
      font-size: 1.1rem;
    }
    .table thead th {
      font-size: 0.85rem;
    }
    .form-label {
      font-size: 0.9rem;
    }
    .form-control, .form-select {
      padding: 0.4rem 0.5rem;
    }
    #quillEditor {
      background-color: white;
    }
  </style>
</head>
<body>
  <div id="header-container"></div>

  <!-- Admin Login -->
  <section id="loginSection" class="d-flex justify-content-center align-items-center mt-5" style="min-height: calc(70vh - 36px);">
    <div class="card shadow p-4 w-100 mx-2" style="max-width: 360px;">
      <div class="text-center mb-4">
        <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 54px; height: 54px;">
          <i class="bi bi-person-fill-lock fs-2"></i>
        </div>
        <h4 class="fw-bold mt-3">Admin Login</h4>
        <p class="text-muted small">Access restricted to authorized admins</p>
      </div>
      <form onsubmit="event.preventDefault(); login();">
        <div class="form-floating mb-3">
          <input type="email" id="email" class="form-control" placeholder="admin@example.com" required />
          <label for="email">Email Address</label>
        </div>
        <div class="form-floating mb-4">
          <input type="password" id="password" class="form-control" placeholder="Password" required />
          <label for="password">Password</label>
        </div>
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-box-arrow-in-right me-1"></i> Sign In
        </button>
      </form>
    </div>
  </section>

  <!-- Admin Panel -->
  <section id="adminPanel" class="container mt-5 d-none">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <h5 class="mb-0">Welcome, <span id="userEmail" class="text-primary"></span></h5>
      <button class="btn btn-outline-secondary btn-sm" onclick="logout()">
        <i class="bi bi-box-arrow-right"></i> Logout
      </button>
    </div>

    <div class="mb-4">
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createJobModal">
        <i class="bi bi-plus-circle"></i> Create Job
      </button>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-hover text-center align-middle">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Title</th>
            <th>Type</th>
            <th>Posted On</th>
            <th>Created By</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="jobsBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Modal: Create Job -->
  <div class="modal fade" id="createJobModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="jobForm">
          <div class="modal-header">
            <h5 class="modal-title">Post a New Job</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Job Title</label>
                <input type="text" id="jobTitle" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label class="form-label">Company Name</label>
                <input type="text" id="jobCompany" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label class="form-label">Job Type</label>
                <select id="jobType" class="form-select" required>
                  <option value="">Select Job Type</option>
                  <option value="Government">Government</option>
                  <option value="Private">Private</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Last Date / Time Info</label>
                <input type="text" id="jobLastDate" class="form-control" placeholder="e.g., 15 Aug 2025, 5 PM" required />
              </div>
            </div>
            <div class="mt-3">
              <label class="form-label">Job Details</label>
              <div id="quillEditor" style="height: 200px;"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Save Job</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Firebase Config & App -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script src="header.js"></script>
  <script src="footer.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAzXgI8kvqz9CEo9393W48yEZjUx6l_YNM",
      authDomain: "rdmjobs-78da3.firebaseapp.com",
      projectId: "rdmjobs-78da3",
      storageBucket: "rdmjobs-78da3.appspot.com",
      messagingSenderId: "850369074130",
      appId: "1:850369074130:web:c96133288fb6cabdd82e0b"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const quill = new Quill("#quillEditor", {
      theme: "snow",
      modules: {
        toolbar: [
          [{ header: [1, 2, false] }],
          ["bold", "italic", "underline"],
          ["link"],
          [{ list: "ordered" }, { list: "bullet" }],
          [{ color: [] }],
          [{ background: [] }]
        ]
      }
    });

    function toggleSections(isLoggedIn, email = "") {
      document.getElementById("loginSection").classList.toggle("d-none", isLoggedIn);
      document.getElementById("adminPanel").classList.toggle("d-none", !isLoggedIn);
      if (isLoggedIn) document.getElementById("userEmail").innerText = email;
    }

    function login() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email, password)
        .then(user => {
          toggleSections(true, user.user.email);
          loadJobs();
        })
        .catch(err => alert("Login failed: " + err.message));
    }

    function logout() {
      auth.signOut().then(() => toggleSections(false));
    }

    function generateCustomJobId(title) {
      const clean = title.replace(/[^a-zA-Z0-9 ]/g, "").trim().replace(/\s+/g, "_");
      return `${clean}_${Math.random().toString(36).substring(2, 6)}`;
    }

    document.getElementById("jobForm").addEventListener("submit", async e => {
      e.preventDefault();
      const title = document.getElementById("jobTitle").value;
      const jobId = generateCustomJobId(title);
      const job = {
        id: jobId,
        title,
        company: document.getElementById("jobCompany").value,
        type: document.getElementById("jobType").value,
        lastDate: document.getElementById("jobLastDate").value, // free text
        content: quill.root.innerHTML,
        createdBy: auth.currentUser.email,
        createdDate: new Date().toISOString().split("T")[0],
        postedAt: new Date().toISOString()
      };

      try {
        await db.collection("jobs").doc(jobId).set(job);
        document.getElementById("jobForm").reset();
        quill.setText("");
        bootstrap.Modal.getInstance(document.getElementById("createJobModal")).hide();
        loadJobs();
      } catch (err) {
        alert("Error saving job");
        console.error(err);
      }
    });

    async function loadJobs() {
      const tbody = document.getElementById("jobsBody");
      tbody.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";
      try {
        const snapshot = await db.collection("jobs").orderBy("postedAt", "desc").get();
        tbody.innerHTML = "";
        let count = 1;
        snapshot.forEach(doc => {
          const job = doc.data();
          tbody.innerHTML += `
            <tr>
              <td>${count++}</td>
              <td>${job.title}</td>
              <td>${job.type}</td>
              <td>${new Date(job.postedAt).toLocaleDateString()}</td>
              <td>${job.createdBy}</td>
              <td>
                <button class="btn btn-sm btn-danger" onclick="deleteJob('${job.id}')">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
      } catch (err) {
        tbody.innerHTML = "<tr><td colspan='6' class='text-danger'>Failed to load jobs</td></tr>";
      }
    }

    window.deleteJob = async function(id) {
      if (!confirm("Delete this job?")) return;
      try {
        await db.collection("jobs").doc(id).delete();
        loadJobs();
      } catch (err) {
        alert("Error deleting job");
        console.error(err);
      }
    };

    auth.onAuthStateChanged(user => {
      if (user) {
        toggleSections(true, user.email);
        loadJobs();
      } else {
        toggleSections(false);
      }
    });

    window.navigateToType = function (type) {
      window.location.href = `jobinformation.html?type=${encodeURIComponent(type)}`;
    };
  </script>
</body>
</html>
