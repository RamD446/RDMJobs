<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RDM Jobs</title>

  <!-- CSS Dependencies -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
</head>

<body>
<div class="site-wrapper">
  <div class="header-container"></div>
  <div id="hero-section"></div>
  <main class="main-content" id="jobList"></main>
  <div class="footer-container"></div> 
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="footer.js"></script>
<script src="header.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getFirestore,
  collection,
  doc,
  getDocs,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAzXgI8kvqz9CEo9393W48yEZjUx6l_YNM",
  authDomain: "rdmjobs-78da3.firebaseapp.com",
  projectId: "rdmjobs-78da3",
  storageBucket: "rdmjobs-78da3.appspot.com",
  messagingSenderId: "850369074130",
  appId: "1:850369074130:web:c96133288fb6cabdd82e0b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Load Jobs
async function loadJobs() {
  const jobList = document.getElementById("jobList");
  jobList.innerHTML = `
    <div class="text-center text-muted py-5">
      <div class="spinner-border text-success mb-3" role="status"></div><br>
      Loading jobs...
    </div>
  `;

  try {
    const q = query(collection(db, "jobs"), orderBy("postedAt", "desc"));
    const snapshot = await getDocs(q);
    jobList.innerHTML = "";

    if (snapshot.empty) {
      jobList.innerHTML = "<p class='text-center'>No jobs posted yet.</p>";
      return;
    }

    const jobGroups = {
      Government: [],
      Private: []
    };

    const allJobs = [];

    snapshot.forEach((docSnap) => {
      const job = docSnap.data();
      const jobId = docSnap.id;
      const fullJob = { ...job, id: jobId };
      allJobs.push(fullJob);

      if (job.type && typeof job.type === "string") {
        const key = job.type.replace(/\s+/g, "");
        if (jobGroups[key] && jobGroups[key].length < 5) {
          jobGroups[key].push(fullJob);
        }
      }
    });

    const formatDate = (dateStr) => {
      const date = new Date(dateStr);
      if (isNaN(date)) return "";
      return `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}/${date.getFullYear()}`;
    };

    const renderJobCard = (job) => {
      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = job.content || "";
      const firstImg = tempDiv.querySelector("img");
      const imageUrl = firstImg ? firstImg.src : "assets/RDMjobslogo.png";

      return `
        <a href="job-details.html?jobId=${job.id}" class="text-decoration-none text-dark">
          <div class="job-card shadow-sm" style="padding: 0.6rem; border-radius: 0.5rem; transition: background-color 0.3s ease; cursor: pointer;"
            onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='white'">
            <img src="${imageUrl}" alt="${job.title}" class="job-card-img" />
            <div class="job-info" style="padding: 0.25rem 0.5rem; font-size: 1rem;">
              <div style="color: #0d6efd; margin-bottom: 4px;">${job.title}</div>
              <div style="color: #198754; margin-bottom: 4px;">${job.company}</div>
              <div style="color: #dc3545;">${job.lastDate}</div>
            </div>
          </div>
        </a>
      `;
    };

    const renderSimpleJobCard = (job) => {
      return `
        <div class="mb-1">
          <a href="job-details.html?jobId=${job.id}" class="text-decoration-none" style="color:#0d6efd;">
            üîπ ${job.title}
          </a>
        </div>
      `;
    };

    // üÜï Latest Job Updates
    const topJobs = allJobs.slice(0, 1000);
    if (topJobs.length > 0) {
      const section = document.createElement("div");
      section.className = "mb-4";
      section.innerHTML = `
        <div class="section-label"
          style="display:inline-block;font-size:0.85rem;font-weight:600;color:#0f172a;background-color:#d1fae5;padding:0.35rem 0.9rem;border-radius:0.5rem;margin-bottom:0.75rem;cursor:default;user-select:none;transition:all 0.25s ease;"
          onmouseover="this.style.backgroundColor='#bbf7d0';this.style.color='#065f46'"
          onmouseout="this.style.backgroundColor='#d1fae5';this.style.color='#0f172a'">
          üÜï Latest Job Updates
        </div>
        <div class="row g-3"></div>
      `;
      const row = section.querySelector(".row");
      topJobs.forEach((job) => {
        const col = document.createElement("div");
        col.className = "col-12 col-md-6";
        col.innerHTML = renderJobCard(job);
        row.appendChild(col);
      });
      jobList.appendChild(section);
    }

    // Categorized Jobs
    const types = ["Government", "Private"];
    const categoryTitles = {
      Government: "üèõ Government Jobs",
      Private: "üè¢ Private Jobs"
    };

    let contentAdded = false;

    for (let i = 0; i < types.length; i += 2) {
      const row = document.createElement("div");
      row.className = "row";

      [types[i], types[i + 1]].forEach((type) => {
        if (!type) return;

        const jobs = jobGroups[type] || [];
        const col = document.createElement("div");
        col.className = "col-12 col-md-6";

        const wrapper = document.createElement("div");
        wrapper.className = "job-category-wrapper";

        const header = `
          <div class="job-category-header d-flex justify-content-between align-items-center mb-2">
            <span style="font-weight:600;">${categoryTitles[type]}</span>
            <a href="jobinformation.html?type=${encodeURIComponent(type)}" title="See All">
              <i class="bi bi-box-arrow-up-right"></i>
            </a>
          </div>
        `;

        let content = "";

        if (jobs.length === 0) {
          content = `<p class="job-category-empty">No ${categoryTitles[type]} found.</p>`;
        } else {
          const cards = jobs.map(renderSimpleJobCard).join("");
          content = `<div class="job-category-cards">${cards}</div>`;
          contentAdded = true;
        }

        wrapper.innerHTML = header + content;
        col.appendChild(wrapper);
        row.appendChild(col);
      });

      jobList.appendChild(row);
    }

    if (!contentAdded) {
      jobList.innerHTML += "<p class='text-center text-muted'>No categorized jobs found to display.</p>";
    }
  } catch (error) {
    console.error("Error loading jobs:", error);
    jobList.innerHTML = "<p class='text-center text-danger'>Failed to load jobs. Please try again later.</p>";
  }
}

loadJobs();

window.navigateToType = function(type) {
  window.location.href = `jobinformation.html?type=${encodeURIComponent(type)}`;
};
</script>

<!-- Hero Section -->
<script type="module">
  import { renderHeroSection } from './heroSection.js';

  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('hero-section');
    if (container) {
      container.innerHTML = renderHeroSection();
    }
  });

  document.addEventListener("DOMContentLoaded", function () {
    const scrollBtn = document.getElementById("scrollToJobs");
    const jobList = document.getElementById("jobList");

    if (scrollBtn && jobList) {
      scrollBtn.addEventListener("click", function () {
        jobList.scrollIntoView({ behavior: "smooth" });
      });
    }
  });
</script>
</body>
</html>
